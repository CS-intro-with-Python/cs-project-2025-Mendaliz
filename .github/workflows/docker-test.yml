name: Docker Flask Test

on: 
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-docker-flask:
    runs-on: ubuntu-latest
    
    steps:
      # 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - name: Checkout code
        uses: actions/checkout@v4
        
      # 2. –°–æ–±–∏—Ä–∞–µ–º Docker –æ–±—Ä–∞–∑
      - name: Build Docker image
        run: |
          echo "üê≥ Building Docker image..."
          docker build -t flask-app .
          
      # 3. –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤ —Ñ–æ–Ω–µ
      - name: Run Docker container
        run: |
          echo "üöÄ Starting Flask server in Docker..."
          docker run -d -p 8080:8080 --name flask-server flask-app
          echo "‚è≥ Waiting for server to start..."
          sleep 10
          
      # 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω
      - name: Check container status
        run: |
          echo "üìä Container status:"
          docker ps
          echo "üìã Container logs:"
          docker logs flask-server || echo "No logs yet"
          
      # 5. –ó–∞–ø—É—Å–∫–∞–µ–º –∫–ª–∏–µ–Ω—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      #- name: Run client test
      #  run: |
      #    echo "üß™ Running client test..."
      #    python client.py

      - name: Run client test careful
        run: |
          echo "üß™ Running client test..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω
          echo "üìä Checking container status:"
          docker ps
          docker ps -a
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞
          echo "üìã Server logs:"
          docker logs flask-server || echo "No logs available"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–±—Ä–æ—Å –ø–æ—Ä—Ç–æ–≤
          echo "üîå Checking port mapping:"
          docker port flask-server
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
          echo "üîç Testing from inside container:"
          docker exec flask-server curl -s http://localhost:5000/ || echo "Cannot connect inside container"
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–ª–∏–µ–Ω—Ç
          python client.py
          
      ## 5. –ó–∞–ø—É—Å–∫–∞–µ–º –∫–ª–∏–µ–Ω—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      #- name: Run client_fail test
      #  run: |
      #    echo "üß™ Running client_fail test..."
      #    python client_fail.py
    
      # 6. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–¥–∞–∂–µ –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã —É–ø–∞–ª–∏)
      - name: Stop container
        if: always()
        run: |
          echo "üõë Stopping container..."
          docker stop flask-server || true
          docker rm flask-server || true