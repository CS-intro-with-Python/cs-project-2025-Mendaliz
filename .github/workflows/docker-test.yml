name: Docker Flask Test

on: 
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-docker-flask:
    runs-on: ubuntu-latest
    
    steps:
      # 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - name: Checkout code
        uses: actions/checkout@v4
        
      # 2. –°–æ–±–∏—Ä–∞–µ–º Docker –æ–±—Ä–∞–∑
      - name: Build Docker image
        run: |
          echo "üê≥ Building Docker image..."
          docker build -t flask-app .
          
      # 3. –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤ —Ñ–æ–Ω–µ
      - name: Run Docker container
        run: |
          echo "üöÄ Starting Flask server in Docker..."
          docker run -d -p 8080:8080 --name flask-server flask-app
          echo "‚è≥ Waiting for server to start..."
          sleep 10
          
      # 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω
      - name: Check container status
        run: |
          echo "üìä Container status:"
          docker ps
          echo "üìã Container logs:"
          docker logs flask-server || echo "No logs yet"
          
      # 5. –ó–∞–ø—É—Å–∫–∞–µ–º –∫–ª–∏–µ–Ω—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      #- name: Run client test
      #  run: |
      #    echo "üß™ Running client test..."
      #    python client.py

      - name: Run client test careful
        run: |
          echo "üß™ Running client test..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω
          echo "üìä Checking container status:"
          docker ps
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞
          echo "üìã Server logs:"
          docker logs flask-server
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å Python (–≤–º–µ—Å—Ç–æ curl)
          echo "üîç Testing from inside container using Python:"
          docker exec flask-server python -c "
          import requests
          try:
              response = requests.get('http://localhost:8080/', timeout=5)
              print(f'‚úÖ INSIDE CONTAINER: Status {response.status_code}')
              print(f'Response: {response.text}')
          except Exception as e:
              print(f'‚ùå INSIDE CONTAINER ERROR: {e}')
          "
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å —Ö–æ—Å—Ç–∞
          echo "üîå Testing from host:"
          curl -s http://localhost:8080/ && echo "‚úÖ Host test successful" || echo "‚ùå Host test failed"
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–ª–∏–µ–Ω—Ç —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø–æ—Ä—Ç–æ–º
          echo "üöÄ Running client test..."
          PORT=8080 python client.py
          
      ## 5. –ó–∞–ø—É—Å–∫–∞–µ–º –∫–ª–∏–µ–Ω—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      #- name: Run client_fail test
      #  run: |
      #    echo "üß™ Running client_fail test..."
      #    python client_fail.py
    
      # 6. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–¥–∞–∂–µ –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã —É–ø–∞–ª–∏)
      - name: Stop container
        if: always()
        run: |
          echo "üõë Stopping container..."
          docker stop flask-server || true
          docker rm flask-server || true