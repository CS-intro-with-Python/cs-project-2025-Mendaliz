name: Docker Flask Test

on: 
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]
  workflow_dispatch:

jobs:
  test-docker-flask:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Build Docker image
        run: |
          echo "ðŸ³ Building Docker image..."
          docker build -t flask-app .
          
      - name: Run Docker container
        run: |
          echo "ðŸš€ Starting Flask server in Docker..."
          docker run --name flask-server flask-app \
            bash -c "
              python -m pytest tests/ -v --tb=short 2>&1 || exit 1
            "
      
      - name: Check container status
        run: |
          echo "ðŸ“‹ Container logs:"
          docker logs flask-server || echo "No logs yet"
          
      - name: Success notification
        if: success()
        run: |
          echo "::notice title=All Tests Passed::âœ… Docker health check completed successfully!"
          echo "ðŸŽ‰ ${OK}ALL CHECKS PASSED${RST} - Server is running correctly"

      - name: Stop container
        if: always()
        run: |
          echo "ðŸ›‘ Stopping container..."
          docker stop flask-server || true
          docker rm flask-server || true